import { useState } from 'react';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Stage, Layer, Text, Image, Transformer } from 'react-konva';
import useImage from 'use-image';

export default function Home() {
  const [text, setText] = useState("Your Design Here");
  const [color, setColor] = useState("black");
  const [items, setItems] = useState([]);
  const [selectedId, setSelectedId] = useState(null);

  const handleImageUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        setItems([...items, { type: 'image', src: reader.result, x: 50, y: 50, width: 100, height: 100, rotation: 0 }]);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleTransform = (index, node) => {
    const updatedItems = [...items];
    updatedItems[index] = {
      ...updatedItems[index],
      x: node.x(),
      y: node.y(),
      width: node.width() * node.scaleX(),
      height: node.height() * node.scaleY(),
      rotation: node.rotation(),
      scaleX: 1,
      scaleY: 1,
    };
    setItems(updatedItems);
  };

  return (
    <div className="bg-gray-100 min-h-screen">
      {/* Navbar */}
      <nav className="bg-blue-600 p-4 text-white flex justify-between items-center">
        <h1 className="text-xl font-bold">Ink N Threadworks</h1>
        <div>
          <Button variant="ghost" className="text-white">Products</Button>
          <Button variant="ghost" className="text-white">Design Tool</Button>
          <Button variant="ghost" className="text-white">Track Order</Button>
        </div>
      </nav>
      
      {/* Hero Section */}
      <header className="text-center py-16 bg-gray-200">
        <h2 className="text-4xl font-bold text-gray-800">Create Custom Apparel with Ease</h2>
        <p className="text-gray-600 mt-2">Upload your design, customize, and place your order in minutes!</p>
        <motion.div whileHover={{ scale: 1.05 }} className="mt-6">
          <Button className="bg-blue-600 text-white px-6 py-3 rounded-lg">Start Designing</Button>
        </motion.div>
      </header>
      
      {/* Design Tool */}
      <section className="p-6">
        <h3 className="text-2xl font-semibold text-gray-700">Design Your Apparel</h3>
        <div className="bg-white p-4 shadow-md rounded-lg mt-4">
          <Stage width={400} height={400} className="border border-gray-300" onMouseDown={() => setSelectedId(null)}>
            <Layer>
              {items.map((item, index) => (
                item.type === 'text' ? (
                  <Text 
                    key={index} 
                    text={item.text} 
                    x={item.x} 
                    y={item.y} 
                    fill={item.color} 
                    fontSize={20} 
                    draggable 
                    onClick={() => setSelectedId(index)}
                  />
                ) : item.type === 'image' ? (
                  <ImageItem 
                    key={index} 
                    item={item} 
                    isSelected={selectedId === index} 
                    onSelect={() => setSelectedId(index)}
                    onTransform={(node) => handleTransform(index, node)}
                  />
                ) : null
              ))}
            </Layer>
          </Stage>
          <div className="mt-4">
            <input type="file" accept="image/*" onChange={handleImageUpload} className="ml-4" />
          </div>
        </div>
      </section>
      
      {/* Footer */}
      <footer className="bg-gray-800 text-white text-center p-4 mt-10">
        <p>&copy; {new Date().getFullYear()} Ink N Threadworks - All Rights Reserved.</p>
      </footer>
    </div>
  );
}

function ImageItem({ item, isSelected, onSelect, onTransform }) {
  const [image] = useImage(item.src);
  const shapeRef = useState(null);
  const trRef = useState(null);

  return (
    <>
      <Image
        image={image}
        x={item.x}
        y={item.y}
        width={item.width}
        height={item.height}
        rotation={item.rotation}
        draggable
        onClick={onSelect}
        onTransformEnd={() => onTransform(shapeRef.current)}
        ref={shapeRef}
      />
      {isSelected && (
        <Transformer
          ref={trRef}
          boundBoxFunc={(oldBox, newBox) => {
            if (newBox.width < 20 || newBox.height < 20) {
              return oldBox;
            }
            return newBox;
          }}
        />
      )}
    </>
  );
}
